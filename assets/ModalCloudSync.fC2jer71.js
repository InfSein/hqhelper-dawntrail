import{h as ue,i as _e,ca as de,b6 as fe,b as pe,aD as ke,a1 as ve,au as he,at as ge,aB as me,B as ye,b3 as y,o as P,q as Q,b$ as X,aV as Y,c9 as we,A as be,f as Ce}from"./index.DIpgTaJR.js";import{a_ as Be,a$ as We,b0 as Se,b1 as Oe,b as Ne}from"./icons._F9tMcs6.js";import{d as xe,k as O,X as Je,r as D,e as I,P as K,o as W,R as p,U as k,Q as c,a as v,c as N,F as Z,Y as L,n as E,V as w}from"./vendor.DOOPojup.js";var e=(i=>(i[i.ConfigBackupUserConfig=5]="ConfigBackupUserConfig",i[i.ConfigBackupFuncConfig=6]="ConfigBackupFuncConfig",i[i.WorkstateBackupMain=9]="WorkstateBackupMain",i[i.WorkstateBackupFtHelper=10]="WorkstateBackupFtHelper",i[i.WorkstateBackupGatherClock=11]="WorkstateBackupGatherClock",i[i.WorkstateBackupWorkflow=12]="WorkstateBackupWorkflow",i[i.WorkstateBackupMacromanage=13]="WorkstateBackupMacromanage",i[i.WorkstateBackupFashioncloth=14]="WorkstateBackupFashioncloth",i[i.WorkstateBackupCsHelper=15]="WorkstateBackupCsHelper",i[i.DataBackupInventory=16]="DataBackupInventory",i))(e||{});const Fe={class:"wrapper"},Me={class:"card-title"},Ue={class:"title"},je={class:"card-title-actions font-small"},De={class:"sync-range-wrapper"},Ie={class:"sync-range-container"},Te={class:"desc"},Ge={key:0,class:"text"},Ee={key:1,class:"text error"},Re={key:2,class:"text"},Ve={class:"card-title"},$e={class:"title"},ze={class:"start-sync-wrapper"},Ae={class:"sync-button-container"},Pe={class:"sync-button-container"},Qe=xe({__name:"ModalCloudSync",props:{show:{type:Boolean,required:!0},showModifiers:{}},emits:["update:show"],setup(i){const a=O("t"),J=O("isMobile"),m=O("userConfig"),S=O("funcConfig"),x=O("cloudConfig"),H=O("appForceUpdate")??(()=>{}),F=ue(),{alertInfo:q,alertError:M,confirm:R}=ye(a),V=_e(),{getListBatch:ee,addList:ae,editList:te,resolveListTitle:oe}=de(x),$=Je(i,"show"),_=D(),C=D(Object.values(e).filter(o=>typeof o=="number").reduce((o,u)=>(o[u]=!0,o),{})),U=D(!1),h=D(!1),ne=()=>{z()},z=async()=>{U.value=!0;const o={},u=Object.values(e).filter(t=>typeof t=="number"),r=await ee(u),n=!r.errno;for(const t of u){let l=0,g="",s=0,f="";if(n&&r.data[t]){const b=r.data[t],{uploadVersion:B,uploadTime:G}=oe(b.desc);l=G,g=B,s=b.id,f=b.content}o[t]={load_succeed:n,last_update:l,upload_version:g,id:s,content:f}}if(_.value=o,x.value.nbb_sync_targets==="all")for(const t of u)C.value[t]=!0;else for(const t of u)C.value[t]=x.value.nbb_sync_targets.includes(t);U.value=!1},A=I(()=>[{key:"preferences",title:a("common.appfunc.user_preference"),children:[{value:e.ConfigBackupUserConfig,label:a("common.appsetting.basic_setting")},{value:e.ConfigBackupFuncConfig,label:a("common.appfunc.func_setting")},{value:e.DataBackupInventory,label:a("common.appfunc.ingame_inventory")}]},{key:"workstates",title:a("common.work_state"),children:[{value:e.WorkstateBackupMain,label:a("common.main_ui")},{value:e.WorkstateBackupGatherClock,label:a("common.appfunc.gather_clock")},{value:e.WorkstateBackupFtHelper,label:a("common.appfunc.fthelper")},{value:e.WorkstateBackupCsHelper,label:a("common.appfunc.cshelper")},{value:e.WorkstateBackupFashioncloth,label:a("common.appfunc.fchelper")},{value:e.WorkstateBackupWorkflow,label:a("common.appfunc.workflow")},{value:e.WorkstateBackupMacromanage,label:a("macro_manage.title")}]}]),T=I(()=>{const o={};return A.value.forEach(u=>{u.children.forEach(r=>{o[r.value]=r.label})}),o}),d=I(()=>Object.values(e).filter(o=>typeof o=="number").filter(o=>C.value[o])),j=I(()=>d.value.filter(o=>!_.value?.[o]?.load_succeed).map(o=>T.value[o])),se=o=>o?a("cloud.text.last_upload",new Date(o).toLocaleString()):a("cloud.text.not_uploaded"),ce=()=>{for(const o of Object.values(e))typeof o=="number"&&(C.value[o]=!0)},le=()=>{for(const o of Object.values(e))typeof o=="number"&&(C.value[o]=!C.value[o])},re=async()=>{if(h.value=!0,j.value.length){await M(a("cloud.message.cannot_sync_because_modules_data_load_failed")+`
-> `+j.value.join(", ")+`
`+a("cloud.message.please_refresh_and_retry")),h.value=!1;return}if(!await R(a("cloud.message.confirm_upload_1")+`
`+a("cloud.message.confirm_upload_2"))){h.value=!1;return}const o=[];for(const n of d.value){const t=await r(n);t.errno&&o.push(a("cloud.message.sync_error",{mod:T.value[n],err:t.errmsg}))}o.length?await M(a("cloud.message.following_modules_sync_failed")+`
`+o.join(`
`)):V.success(a("cloud.message.sync_succeed"));const u=y(x.value);u.nbb_sync_targets=d.value,F.setCloudConfig(u),H(),await z(),h.value=!1;async function r(n){let t="";switch(n){case e.ConfigBackupUserConfig:{const s=y(m.value);delete s.cache_work_state,delete s.fthelper_cache_work_state,delete s.gatherclock_cache_work_state,delete s.workflow_cache_work_state,delete s.macromanage_cache_work_state,delete s.fashioncloth_cache_work_state,t=JSON.stringify(s);break}case e.ConfigBackupFuncConfig:{const s=y(S.value);delete s.inventory_statement_enable_sync,delete s.inventory_workflow_enable_sync,delete s.inventory_other_items_way,delete s.inventory_data,delete s.cache_item_prices,t=JSON.stringify(s);break}case e.WorkstateBackupMain:t=JSON.stringify(m.value.cache_work_state);break;case e.WorkstateBackupFtHelper:t=JSON.stringify(m.value.fthelper_cache_work_state);break;case e.WorkstateBackupGatherClock:t=JSON.stringify(m.value.gatherclock_cache_work_state);break;case e.WorkstateBackupWorkflow:{const s=Y(m.value.workflow_cache_work_state);t=JSON.stringify(s);break}case e.WorkstateBackupMacromanage:{const s=X(m.value.macromanage_cache_work_state);t=JSON.stringify(s);break}case e.WorkstateBackupFashioncloth:{const s=Q(m.value.fashioncloth_cache_work_state);t=JSON.stringify(s);break}case e.WorkstateBackupCsHelper:{const s=P(m.value.cshelper_cache_work_state);t=JSON.stringify(s);break}case e.DataBackupInventory:t=JSON.stringify({inventory_statement_enable_sync:S.value.inventory_statement_enable_sync,inventory_workflow_enable_sync:S.value.inventory_workflow_enable_sync,inventory_other_items_way:S.value.inventory_other_items_way,inventory_data:S.value.inventory_data});break;default:return{errno:1,errmsg:"Unexpected listtype"+n,data:{}}}const l=!_.value[n].id;let g;if(l)g=await ae(n,t);else{const s=_.value[n].id;g=await te(s,t)}return g}},ie=async()=>{if(h.value=!0,j.value.length){await M(a("cloud.message.cannot_sync_because_modules_data_load_failed")+`
-> `+j.value.join(", ")+`
`+a("cloud.message.please_refresh_and_retry")),h.value=!1;return}const o=d.value.filter(f=>!_.value?.[f]?.last_update).map(f=>T.value[f]);if(o.length){await M(a("cloud.message.cannot_sync_because_modules_data_not_uploaded")+`
-> `+o.join(", ")+`
`+a("cloud.message.please_upload_first")),h.value=!1;return}if(!await R(a("cloud.message.confirm_download_1")+`
`+a("cloud.message.confirm_download_2"))){h.value=!1;return}let u=!1;const r=y(m.value);let n=y(m.value);d.value.includes(e.ConfigBackupUserConfig)&&(n=JSON.parse(_.value[e.ConfigBackupUserConfig].content)),n.cache_lasttime_version=r.cache_lasttime_version,d.value.includes(e.WorkstateBackupMain)?n.cache_work_state=JSON.parse(_.value[e.WorkstateBackupMain].content):n.cache_work_state=r.cache_work_state,d.value.includes(e.WorkstateBackupFtHelper)?n.fthelper_cache_work_state=JSON.parse(_.value[e.WorkstateBackupFtHelper].content):n.fthelper_cache_work_state=r.fthelper_cache_work_state,d.value.includes(e.WorkstateBackupGatherClock)?n.gatherclock_cache_work_state=JSON.parse(_.value[e.WorkstateBackupGatherClock].content):n.gatherclock_cache_work_state=r.gatherclock_cache_work_state,d.value.includes(e.WorkstateBackupWorkflow)?n.workflow_cache_work_state=Y(JSON.parse(_.value[e.WorkstateBackupWorkflow].content)):n.workflow_cache_work_state=r.workflow_cache_work_state,d.value.includes(e.WorkstateBackupMacromanage)?n.macromanage_cache_work_state=X(JSON.parse(_.value[e.WorkstateBackupMacromanage].content)):n.macromanage_cache_work_state=r.macromanage_cache_work_state,d.value.includes(e.WorkstateBackupFashioncloth)?n.fashioncloth_cache_work_state=Q(JSON.parse(_.value[e.WorkstateBackupFashioncloth].content)):n.fashioncloth_cache_work_state=r.fashioncloth_cache_work_state,d.value.includes(e.WorkstateBackupCsHelper)?n.cshelper_cache_work_state=P(JSON.parse(_.value[e.WorkstateBackupCsHelper].content)):n.cshelper_cache_work_state=r.cshelper_cache_work_state,JSON.stringify(r)!==JSON.stringify(n)?(console.log(`userconfig json diff.
`,JSON.stringify(r),JSON.stringify(n)),u=!0,n=we(n),F.setUserConfig(n)):console.log("[CloudSync] Tip: no changes for userConfig.");const t=y(S.value);let l=y(S.value);if(d.value.includes(e.ConfigBackupFuncConfig)&&(l=JSON.parse(_.value[e.ConfigBackupFuncConfig].content)),d.value.includes(e.DataBackupInventory)){const f=JSON.parse(_.value[e.DataBackupInventory].content);l.inventory_statement_enable_sync=f.inventory_statement_enable_sync,l.inventory_workflow_enable_sync=f.inventory_workflow_enable_sync,l.inventory_other_items_way=f.inventory_other_items_way,l.inventory_data=y(f.inventory_data)}else l.inventory_statement_enable_sync=t.inventory_statement_enable_sync,l.inventory_workflow_enable_sync=t.inventory_workflow_enable_sync,l.inventory_other_items_way=t.inventory_other_items_way,l.inventory_data=y(t.inventory_data);let g=!1;t.universalis_server!==l.universalis_server?(l.cache_item_prices={},g=!0):l.cache_item_prices=t.cache_item_prices,JSON.stringify(t)!==JSON.stringify(l)?(console.log(`funcconfig json diff.
`,JSON.stringify(t),JSON.stringify(l)),u=!0,l=be(l),F.setFuncConfig(l)):console.log("[CloudSync] Tip: no changes for funcConfig.");const s=y(x.value);if(s.nbb_sync_targets=d.value,F.setCloudConfig(s),h.value=!1,u){const f=[a("cloud.message.sync_succeed")];g&&f.push(a("cloud.message.cache_cleaned")),f.push(a("cloud.message.page_would_be_reloaded")),await q(f.join(`
`)),setTimeout(()=>{window.electronAPI?.closeAllChildWindows?.(),location.reload()},500)}else V.success(a("cloud.message.data_consistent"))};return(o,u)=>{const r=he,n=ve,t=ke,l=pe,g=ge,s=fe,f=me;return W(),K(f,{show:$.value,"onUpdate:show":u[0]||(u[0]=b=>$.value=b),icon:c(Ne),title:c(a)("cloud.text.data_sync"),"max-width":"600px",onOnLoad:ne},{default:p(()=>[k(s,{show:c(U)},{default:p(()=>[v("div",Fe,[k(l,{size:"small",embedded:""},{header:p(()=>[v("div",Me,[k(r,null,{default:p(()=>[k(c(Be))]),_:1}),v("span",Ue,w(c(a)("cloud.text.sync_range")),1),v("div",je,[v("a",{href:"javascript:void(0)",onClick:ce},"["+w(c(a)("common.select_all"))+"]",1),v("a",{href:"javascript:void(0)",onClick:le},"["+w(c(a)("common.select_invert"))+"]",1)])])]),default:p(()=>[v("div",De,[(W(!0),N(Z,null,L(c(A),b=>(W(),K(t,{key:b.key,title:b.title},{default:p(()=>[v("div",Ie,[(W(!0),N(Z,null,L(b.children,B=>(W(),N("div",{key:`syncrange-${B.value}`,class:"item"},[k(n,{checked:c(C)[B.value],"onUpdate:checked":G=>c(C)[B.value]=G},{default:p(()=>[E(w(B.label),1)]),_:2},1032,["checked","onUpdate:checked"]),v("div",Te,[c(U)?(W(),N("div",Ge,w(c(a)("cloud.text.loading")),1)):c(_)?.[B.value]?.load_succeed?(W(),N("div",Re,w(se(c(_)[B.value].last_update)),1)):(W(),N("div",Ee,w(c(a)("common.load_failed")),1))])]))),128))])]),_:2},1032,["title"]))),128))])]),_:1}),k(l,{size:"small",embedded:""},{header:p(()=>[v("div",Ve,[k(r,null,{default:p(()=>[k(c(Oe))]),_:1}),v("span",$e,w(c(a)("cloud.text.start_sync")),1)])]),default:p(()=>[v("div",ze,[k(g,{text:!c(J),loading:c(h),disabled:c(h)||!c(d).length,onClick:re},{default:p(()=>[v("div",Ae,[k(r,{size:c(J)?16:48},{default:p(()=>[k(c(We))]),_:1},8,["size"]),E(" "+w(c(a)("cloud.text.upload_data")),1)])]),_:1},8,["text","loading","disabled"]),k(g,{text:!c(J),loading:c(h),disabled:c(h)||!c(d).length,onClick:ie},{default:p(()=>[v("div",Pe,[k(r,{size:c(J)?16:48},{default:p(()=>[k(c(Se))]),_:1},8,["size"]),E(" "+w(c(a)("cloud.text.download_data")),1)])]),_:1},8,["text","loading","disabled"])])]),_:1})])]),_:1},8,["show"])]),_:1},8,["show","icon","title"])}}}),Ze=Ce(Qe,[["__scopeId","data-v-b92d3de3"]]);export{Ze as default};
