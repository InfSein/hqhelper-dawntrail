import{d as ce,k as Y,X as de,f as ue,j as pe,r as w,e as R,P as F,o as x,R as l,a as s,U as i,S as _e,c as b,F as ge,Y as me,Q as n,n as y,V as r,N as Q,Z as j,q as he,y as ve}from"./vendor.DaGD8wRy.js";import{f as fe,c6 as H,F as we,bj as xe,aQ as ye,at as ke,au as Pe,a as be,b7 as Ue,aX as Te,aB as Ce,A as Se,b5 as Ae,c7 as Ie,e as Re}from"./index.CG8fR3B8.js";import{aM as Ve,aN as qe,aO as K,aP as Ne,aQ as Ee,al as Oe}from"./icons.BN6_TYLH.js";const Be=async V=>{let e=V;!e.startsWith("https://")&&!e.startsWith("http://")&&(e=`https://${V}`);const U=1500,T=new AbortController,c=T.signal,C=Date.now(),q=setTimeout(()=>{T.abort()},U);try{let _;if(window.electronAPI?.httpGet?_=await window.electronAPI.httpGet(e):_=await fetch(e,{mode:"no-cors",signal:c}),typeof _!="string"&&!_.ok&&_.status)throw new Error(`HTTP 错误: ${_.status}`);const o=Date.now()-C;return clearTimeout(q),o}catch(_){return console.error("GET",e,`FAILED DUE TO
`,_),String(_).includes("CORS")?"unknown":"timeout"}},ze={class:"wrapper"},Me={class:"card-title"},Fe={class:"title"},je={class:"card-title-actions font-small"},He={class:"proxy-card-container"},De={class:"proxy-selection-container"},Ge={class:"proxy-option"},We={class:"proxy-item"},Xe={class:"proxy-option"},$e={class:"proxy-ping"},Le={class:"edge-top-right"},Ye={class:"card-title"},Qe={class:"title"},Ke={class:"version-card-container"},Ze={class:"versions"},Je={key:0},et={key:1},tt={key:2},nt={class:"edge-top-right"},at={class:"action"},ot={class:"card-title"},st={class:"title"},lt={class:"version-card-container"},rt={class:"versions"},it={key:0},ct={key:1},dt={key:2},ut={class:"edge-top-right"},pt={class:"action"},_t=ce({__name:"ModalCheckUpdates",props:{show:{type:Boolean,required:!0},showModifiers:{}},emits:["update:show"],setup(V){const e=Y("t"),U=Y("userConfig"),T=fe(),{alertError:c,confirm:C}=Se(e),q=de(V,"show");ue(()=>{window.electronAPI?.onUpdateProgress?window.electronAPI.onUpdateProgress(te):o.titleText=e("update.message.require_ver_plus_client_to_see_progress",{ver:"v3"}),v.value=U.value.use_custom_proxy,m.value=U.value.custom_proxy_url});const _=async()=>{window.electronAPI?.clientVersion&&(N.value=await window.electronAPI?.clientVersion),z()},S=w(!1),o=pe({updating:!1,updating_hqhelper:!1,updating_electron:!1,error:!1,titleText:"",contentText:"",downloaded:"",total:"",downloadSpeed:""}),h=w(),g=w(""),p=w(""),v=w(!1),m=w(""),O=w("https://ghfast.top"),A=w({}),D=[{label:e("update.proxy.dont_use_proxy"),value:""},{label:"ghfast.top",value:"https://ghfast.top"},{label:"github.moeyy.xyz",value:"https://github.moeyy.xyz"},{label:"gh.jasonzeng.dev",value:"https://gh.jasonzeng.dev/"}],N=w("UNKNOWN"),Z=R(()=>g.value&&g.value!=H.Version),J=R(()=>p.value&&p.value!=N.value),B=R(()=>{let a=O.value||"";return v.value&&(a=m.value||""),a&&(a=`${a}/`),a}),ee=()=>{window.open("https://ghproxy.link/")},te=a=>{const t=a.error,d=k(a.stage);if(o.error=!!t,o.downloaded=a.progress?.downloaded??"???",o.total=a.progress?.total??"???",o.downloadSpeed=a.progress?.speed??"???",o.titleText=t?e("update.message.stage_failed",k(t.onstage)):e("update.message.staging",d),a.stage==="downloading"&&(o.titleText+=" "+e("update.message.downloaded_and_speed",{now:o.downloaded,total:o.total,speed:o.downloadSpeed})),o.contentText="",t?.msg){const P=t.msg;o.contentText=P;try{const f=P.match(/AxiosError: Request failed with status code (\d{1,4})/);if(f){const I=f[1];o.contentText=e("update.message.error_with_netcode",[I]),I==="404"&&(o.contentText+=e("update.message.error_404_possible_reason"))}P.includes("EPERM: operation not permitted, copyfile")&&(o.contentText=e("update.message.error_epem_operation_not_permitted"))}catch(f){console.error("更新发生错误，并且错误文本解析期间出现问题。",`
error:`,t,`
parse error:`,f)}}a.stage==="end"&&(o.updating_hqhelper=!1,o.updating_electron=!1),o.updating=o.updating_hqhelper||o.updating_electron;function k(P){switch(P){case"requesting":return e("update.stage.connecting");case"downloading":return e("update.stage.downloading");case"extracting":return e("update.stage.extracting");case"replacing":return e("update.stage.replacing");case"cleaning":return e("update.stage.cleaning");case"relaunching":return e("update.stage.restarting");case"opening":return e("update.stage.opening");case"end":default:return""}}},z=async()=>{if(!window.electronAPI?.httpGet){await c("electronAPI.httpGet is not defined");return}S.value=!0,g.value="",p.value="";try{const t=await Ae();t.success?(h.value=t.data,g.value=h.value.hqhelper,p.value=h.value.electron):await a(t.message,t)}catch(t){await a(t?.message||"UNKNOWN ERROR",t)}finally{S.value=!1}async function a(t,d){console.error(d),await c(e("update.message.check_update_failed_with_error",t)),g.value=null,p.value=null}},G=(a,t)=>t===""?e("common.checking"):t===null?e("common.check_failed"):a===t?e("update.message.already_latest"):e("common.update_immedi",t),ne=R(()=>o.updating_hqhelper?e("common.updating"):G(H.Version,g.value)),ae=R(()=>o.updating_electron?e("common.updating"):G(N.value,p.value)),oe=a=>{v.value=!1,O.value=a.target.value},se=async()=>{A.value={};const a=window.electronAPI?.simulatePing||Be,t=async d=>{try{return await a(d||"github.com")}catch{return"error"}};for(const d of D.map(k=>k.value))A.value[d]=await t(d);v.value&&m.value&&(A.value[m.value]=await t(m.value))},W=a=>{const t=A.value[a];return t===void 0?"":t==="timeout"?e("common.timeout"):t==="unknown"?e("common.unknown"):t==="error"?e("common.error"):t+"ms"},X=a=>{const t=A.value[a];return t===void 0?"display: none;":t==="timeout"||t==="error"?"color: red;":t==="unknown"?"color: royalblue;":t<200?"color: green;":t<400?"color: orange;":"color: orangered;"},M=()=>{const a=Ie(T.userConfig);a.use_custom_proxy=v.value,a.custom_proxy_url=m.value,T.setUserConfig(a)},le=async()=>{if(!window.electronAPI?.downloadUpdatePack){await c("electronAPI.downloadUpdatePack is not defined");return}if(!await C(e("update.alert_text.text_1")+`
`+e("update.alert_text.text_2")+`
`+e("update.alert_text.text_3")+`
`+e("update.alert_text.text_4")))return;o.updating_hqhelper=!0,M();let a=h.value?.dlink_hqhelper;if(!a)await c("Update link not given. Server might be undergoing maintenance...");else if(!g.value)await c("latestHqHelperVersion not given, Please retry later.");else if(h.value?.maintenance_webpack)await c(e("update.message.server_under_maintenance")+`
`+e("common.message.please_wait_for_a_while"));else{a=a.replace("~PROXY",B.value),a=a.replace("~VERSION",g.value);const t=await window.electronAPI.downloadUpdatePack(a);t&&(await c(e("update.message.download_update_pack_failed_with_error",t)),o.titleText="")}},$=async()=>{let a="";return window.electronAPI?.clientPlatform&&await window.electronAPI.clientPlatform==="darwin"?a=h.value?.dlink_electron_mac:a=h.value?.dlink_electron,a},re=async()=>{if(U.value.update_client_builtin){if(!window.electronAPI?.downloadAndOpen){await c(`function downloadAndOpen is not defined.
Please check the client version (v6+ is required).`);return}if(!await C(e("update.alert_text.text_8")+`
`+e("update.alert_text.text_9")+`
`+e("update.alert_text.text_3")+`
`+e("update.alert_text.text_4")))return;o.updating_electron=!0,M();let a=await $();if(!a)await c("Update link not given. Server might be undergoing maintenance...");else if(!p.value)await c("latestElectronVersion not given, Please retry later.");else if(h.value?.maintenance_client)await c(e("update.message.server_under_maintenance")+`
`+e("common.message.please_wait_for_a_while"));else{a=a.replace("~PROXY",B.value),a=a.replace("~VERSION",p.value);const t=await window.electronAPI.downloadAndOpen(a,e("update.file_name.client_updater")+".exe");t&&(await c(e("update.message.download_client_pack_failed_with_error",t)),o.titleText="")}}else{if(!await C(e("update.alert_text.text_5")+`
`+e("update.alert_text.text_6")+`
`+e("update.alert_text.text_7")+`
`+e("update.alert_text.text_4")))return;M();const a=window.electronAPI?.openUrlByBrowser??window.open;let t=await $();t?p.value?h.value?.maintenance_client?await c(e("update.message.server_under_maintenance")+`
`+e("common.message.please_wait_for_a_while")):(t=t.replace("~PROXY",B.value),t=t.replace("~VERSION",p.value),a(t)):await c("latestElectronVersion not given, Please retry later."):await c("Update link not given. Server might be undergoing maintenance...")}},E=w(!1),ie=()=>{E.value=!0};return(a,t)=>{const d=Pe,k=xe,P=ye,f=ke,I=be,L=Ue;return x(),F(Ce,{show:q.value,"onUpdate:show":t[3]||(t[3]=u=>q.value=u),icon:n(Oe),title:n(e)("common.appfunc.check_updates"),height:"auto",onOnLoad:_,"show-setting":"",onOnSettingButtonClicked:ie},{default:l(()=>[s("div",ze,[i(we,{class:"card proxy","card-key":"modal-cu-proxy","card-size":"small","disable-glass":"","show-card-border":""},{header:l(()=>[s("div",Me,[i(d,null,{default:l(()=>[i(n(qe))]),_:1}),s("span",Fe,r(n(e)("update.proxy.title")),1),s("div",je,[s("a",{href:"javascript:void(0)",onClick:ee},"["+r(n(e)("update.text.proxy_status_view"))+"]",1)])])]),default:l(()=>[s("div",He,[t[4]||(t[4]=s("div",{class:"tip-text"},null,-1)),t[5]||(t[5]=s("div",{class:"proxy-actions"},null,-1)),s("div",De,[(x(),b(ge,null,me(D,u=>s("div",{class:"proxy-item",key:"proxy-"+u.value},[s("div",Ge,[i(k,{name:"proxy-option",checked:!n(v)&&n(O)===u.value,value:u.value,onChange:oe},{default:l(()=>[y(r(u.label),1)]),_:2},1032,["checked","value"])]),s("div",{class:"proxy-ping",style:Q(X(u.value))},r(W(u.value)),5)])),64)),s("div",We,[s("div",Xe,[i(k,{name:"proxy-option",checked:n(v),"onUpdate:checked":t[0]||(t[0]=u=>j(v)?v.value=u:null)},{default:l(()=>[y(r(n(e)("update.text.custom_proxy")),1)]),_:1},8,["checked"])]),s("div",$e,[he(i(P,{size:"tiny",value:n(m),"onUpdate:value":t[1]||(t[1]=u=>j(m)?m.value=u:null),style:{width:"250px"}},{suffix:l(()=>[s("div",{class:"proxy-ping",style:Q(X(n(m)))}," ("+r(W(n(m)))+") ",5)]),_:1},8,["value"]),[[ve,n(v)]])])])]),s("div",Le,[i(f,{size:"tiny",onClick:se},{icon:l(()=>[i(d,null,{default:l(()=>[i(n(Ve))]),_:1})]),default:l(()=>[y(" "+r(n(e)("update.text.check_connections")),1)]),_:1})])])]),_:1}),i(I,{class:"card web-version",size:"small",embedded:""},{header:l(()=>[s("div",Ye,[i(d,null,{default:l(()=>[i(n(Ne))]),_:1}),s("span",Qe,r(n(e)("common.hqhelper_version")),1)])]),default:l(()=>[s("div",Ke,[s("div",Ze,[s("div",null,r(n(e)("common.curr_version_with_val",n(H).Version)),1),s("div",null,[s("span",null,r(n(e)("common.latest_version")),1),n(g)?(x(),b("span",Je,r(n(g)),1)):n(g)===""?(x(),b("span",et,r(n(e)("common.checking")),1)):(x(),b("span",tt,r(n(e)("common.check_failed")),1))])]),s("div",nt,[i(f,{size:"tiny",class:"btn-recheck",loading:n(S),onClick:z},{icon:l(()=>[i(d,null,{default:l(()=>[i(n(K))]),_:1})]),default:l(()=>[y(" "+r(n(e)("common.recheck")),1)]),_:1},8,["loading"])]),s("div",at,[i(f,{class:"btn-do-update",loading:n(o).updating_hqhelper,disabled:!n(Z)||n(o).updating_hqhelper,onClick:le},{default:l(()=>[y(r(n(ne)),1)]),_:1},8,["loading","disabled"])])])]),_:1}),i(I,{class:"card web-version",size:"small",embedded:""},{header:l(()=>[s("div",ot,[i(d,null,{default:l(()=>[i(n(Ee))]),_:1}),s("span",st,r(n(e)("common.client_version")),1)])]),default:l(()=>[s("div",lt,[s("div",rt,[s("div",null,r(n(e)("common.curr_version_with_val",n(N))),1),s("div",null,[s("span",null,r(n(e)("common.latest_version")),1),n(p)?(x(),b("span",it,r(n(p)),1)):n(p)===""?(x(),b("span",ct,r(n(e)("common.checking")),1)):(x(),b("span",dt,r(n(e)("common.check_failed")),1))])]),s("div",ut,[i(f,{size:"tiny",class:"btn-recheck",loading:n(S),onClick:z},{icon:l(()=>[i(d,null,{default:l(()=>[i(n(K))]),_:1})]),default:l(()=>[y(" "+r(n(e)("common.recheck")),1)]),_:1},8,["loading"])]),s("div",pt,[i(f,{class:"btn-do-update",loading:n(o).updating_electron,disabled:!n(J)||n(o).updating_electron,onClick:re},{default:l(()=>[y(r(n(ae)),1)]),_:1},8,["loading","disabled"])])])]),_:1}),n(o).error?(x(),F(L,{key:0,class:"card upd-tip",type:"error",title:n(o).titleText},{default:l(()=>[y(r(n(o).contentText),1)]),_:1},8,["title"])):n(o).updating&&n(o).titleText?(x(),F(L,{key:1,class:"card upd-tip",type:"info"},{default:l(()=>[y(r(n(o).titleText),1)]),_:1})):_e("",!0)]),i(Te,{show:n(E),"onUpdate:show":t[2]||(t[2]=u=>j(E)?E.value=u:null),"setting-group":"update","app-show-fp":""},null,8,["show"])]),_:1},8,["show","icon","title"])}}}),vt=Re(_t,[["__scopeId","data-v-6d5c2016"]]);export{vt as default};
