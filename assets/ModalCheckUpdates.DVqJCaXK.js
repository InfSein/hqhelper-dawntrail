import{h as ue,c8 as j,_ as pe,bj as _e,aQ as ge,at as me,au as he,b as ve,b7 as fe,aX as we,aB as xe,B as ye,b5 as ke,c9 as Pe,f as be}from"./index.DIpgTaJR.js";import{d as Ue,k as Q,X as Te,f as Ce,j as Se,r as w,e as I,P as F,o as x,R as l,a as s,U as i,S as Ae,c as b,F as Ie,Y as Re,Q as n,n as y,V as r,N as K,Z as H,q as Ve,y as qe}from"./vendor.DOOPojup.js";import{aM as Ne,aN as Ee,aO as Z,aP as Oe,aQ as Be,al as ze}from"./icons._F9tMcs6.js";const Me=async R=>{let e=R;!e.startsWith("https://")&&!e.startsWith("http://")&&(e=`https://${R}`);const U=1500,T=new AbortController,c=T.signal,C=Date.now(),V=setTimeout(()=>{T.abort()},U);try{let _;if(window.electronAPI?.httpGet?_=await window.electronAPI.httpGet(e):_=await fetch(e,{mode:"no-cors",signal:c}),typeof _!="string"&&!_.ok&&_.status)throw new Error(`HTTP 错误: ${_.status}`);const o=Date.now()-C;return clearTimeout(V),o}catch(_){return console.error("GET",e,`FAILED DUE TO
`,_),String(_).includes("CORS")?"unknown":"timeout"}},je={class:"wrapper"},Fe={class:"card-title"},He={class:"title"},De={class:"card-title-actions font-small"},Ge={class:"proxy-card-container"},We={class:"proxy-selection-container"},Xe={class:"proxy-option"},$e={class:"proxy-item"},Le={class:"proxy-option"},Ye={class:"proxy-ping"},Qe={class:"edge-top-right"},Ke={class:"card-title"},Ze={class:"title"},Je={class:"version-card-container"},et={class:"versions"},tt={key:0},nt={key:1},at={key:2},ot={class:"edge-top-right"},st={class:"action"},lt={class:"card-title"},rt={class:"title"},it={class:"version-card-container"},ct={class:"versions"},dt={key:0},ut={key:1},pt={key:2},_t={class:"edge-top-right"},gt={class:"action"},mt=Ue({__name:"ModalCheckUpdates",props:{show:{type:Boolean,required:!0},showModifiers:{}},emits:["update:show"],setup(R){const e=Q("t"),U=Q("userConfig"),T=ue(),{alertError:c,confirm:C}=ye(e),V=Te(R,"show");Ce(()=>{window.electronAPI?.onUpdateProgress?window.electronAPI.onUpdateProgress(ne):o.titleText=e("update.message.require_ver_plus_client_to_see_progress",{ver:"v3"}),v.value=U.value.use_custom_proxy,m.value=U.value.custom_proxy_url});const _=async()=>{window.electronAPI?.clientVersion&&(q.value=await window.electronAPI?.clientVersion),z()},S=w(!1),o=Se({updating:!1,updating_hqhelper:!1,updating_electron:!1,error:!1,titleText:"",contentText:"",downloaded:"",total:"",downloadSpeed:""}),h=w(),g=w(""),p=w(""),v=w(!1),m=w(""),O=w("https://ghfast.top"),A=w({}),D=[{label:e("update.proxy.dont_use_proxy"),value:""},{label:"ghfast.top",value:"https://ghfast.top"},{label:"github.moeyy.xyz",value:"https://github.moeyy.xyz"},{label:"gh.jasonzeng.dev",value:"https://gh.jasonzeng.dev/"}],q=w("UNKNOWN"),J=I(()=>g.value&&g.value!=j.Version),ee=I(()=>p.value&&p.value!=q.value),B=I(()=>{let a=O.value||"";return v.value&&(a=m.value||""),a&&(a=`${a}/`),a}),te=()=>{window.open("https://ghproxy.link/")},ne=a=>{const t=a.error,d=k(a.stage);if(o.error=!!t,o.downloaded=a.progress?.downloaded??"???",o.total=a.progress?.total??"???",o.downloadSpeed=a.progress?.speed??"???",o.titleText=t?e("update.message.stage_failed",k(t.onstage)):e("update.message.staging",d),a.stage==="downloading"&&(o.titleText+=" "+e("update.message.downloaded_and_speed",{now:o.downloaded,total:o.total,speed:o.downloadSpeed})),o.contentText="",t?.msg){const P=t.msg;o.contentText=P;try{const f=P.match(/AxiosError: Request failed with status code (\d{1,4})/);if(f){const E=f[1];o.contentText=e("update.message.error_with_netcode",[E]),E==="404"&&(o.contentText+=e("update.message.error_404_possible_reason"))}P.includes("EPERM: operation not permitted, copyfile")&&(o.contentText=e("update.message.error_epem_operation_not_permitted"))}catch(f){console.error("更新发生错误，并且错误文本解析期间出现问题。",`
error:`,t,`
parse error:`,f)}}a.stage==="end"&&(o.updating_hqhelper=!1,o.updating_electron=!1),o.updating=o.updating_hqhelper||o.updating_electron;function k(P){switch(P){case"requesting":return e("update.stage.connecting");case"downloading":return e("update.stage.downloading");case"extracting":return e("update.stage.extracting");case"replacing":return e("update.stage.replacing");case"cleaning":return e("update.stage.cleaning");case"relaunching":return e("update.stage.restarting");case"opening":return e("update.stage.opening");case"end":default:return""}}},z=async()=>{if(!window.electronAPI?.httpGet){await c("electronAPI.httpGet is not defined");return}S.value=!0,g.value="",p.value="";try{const t=await ke();t.success?(h.value=t.data,g.value=h.value.hqhelper,p.value=h.value.electron):await a(t.message,t)}catch(t){await a(t?.message||"UNKNOWN ERROR",t)}finally{S.value=!1}async function a(t,d){console.error(d),await c(e("update.message.check_update_failed_with_error",t)),g.value=null,p.value=null}},G=(a,t)=>t===""?e("common.checking"):t===null?e("common.check_failed"):a===t?e("update.message.already_latest"):e("common.update_immedi",t),ae=I(()=>o.updating_hqhelper?e("common.updating"):G(j.Version,g.value)),oe=I(()=>o.updating_electron?e("common.updating"):G(q.value,p.value)),se=a=>{v.value=!1,O.value=a.target.value},le=async()=>{A.value={};const a=window.electronAPI?.simulatePing||Me,t=async d=>{try{return await a(d||"github.com")}catch{return"error"}};for(const d of D.map(k=>k.value))A.value[d]=await t(d);v.value&&m.value&&(A.value[m.value]=await t(m.value))},W=a=>{const t=A.value[a];return t===void 0?"":t==="timeout"?e("common.timeout"):t==="unknown"?e("common.unknown"):t==="error"?e("common.error"):t+"ms"},X=a=>{const t=A.value[a];return t===void 0?"display: none;":t==="timeout"||t==="error"?"color: red;":t==="unknown"?"color: royalblue;":t<200?"color: green;":t<400?"color: orange;":"color: orangered;"},M=()=>{const a=Pe(T.userConfig);a.use_custom_proxy=v.value,a.custom_proxy_url=m.value,T.setUserConfig(a)},re=async()=>{if(!window.electronAPI?.downloadUpdatePack){await c("electronAPI.downloadUpdatePack is not defined");return}if(!await C(e("update.alert_text.text_1")+`
`+e("update.alert_text.text_2")+`
`+e("update.alert_text.text_3")+`
`+e("update.alert_text.text_4")))return;o.updating_hqhelper=!0,M();let a=h.value?.dlink_hqhelper;if(!a)await c("Update link not given. Server might be undergoing maintenance...");else if(!g.value)await c("latestHqHelperVersion not given, Please retry later.");else if(h.value?.maintenance_webpack)await c(e("update.message.server_under_maintenance")+`
`+e("common.message.please_wait_for_a_while"));else{a=a.replace("~PROXY",B.value),a=a.replace("~VERSION",g.value);const t=await window.electronAPI.downloadUpdatePack(a);t&&(await c(e("update.message.download_update_pack_failed_with_error",t)),o.titleText="")}},$=async()=>{let a="";return window.electronAPI?.clientPlatform&&await window.electronAPI.clientPlatform==="darwin"?a=h.value?.dlink_electron_mac:a=h.value?.dlink_electron,a},ie=async()=>{if(U.value.update_client_builtin){if(!window.electronAPI?.downloadAndOpen){await c(`function downloadAndOpen is not defined.
Please check the client version (v6+ is required).`);return}if(!await C(e("update.alert_text.text_8")+`
`+e("update.alert_text.text_9")+`
`+e("update.alert_text.text_3")+`
`+e("update.alert_text.text_4")))return;o.updating_electron=!0,M();let a=await $();if(!a)await c("Update link not given. Server might be undergoing maintenance...");else if(!p.value)await c("latestElectronVersion not given, Please retry later.");else if(h.value?.maintenance_client)await c(e("update.message.server_under_maintenance")+`
`+e("common.message.please_wait_for_a_while"));else{a=a.replace("~PROXY",B.value),a=a.replace("~VERSION",p.value);const t=await window.electronAPI.downloadAndOpen(a,e("update.file_name.client_updater")+".exe");t&&(await c(e("update.message.download_client_pack_failed_with_error",t)),o.titleText="")}}else{if(!await C(e("update.alert_text.text_5")+`
`+e("update.alert_text.text_6")+`
`+e("update.alert_text.text_7")+`
`+e("update.alert_text.text_4")))return;M();const a=window.electronAPI?.openUrlByBrowser??window.open;let t=await $();t?p.value?h.value?.maintenance_client?await c(e("update.message.server_under_maintenance")+`
`+e("common.message.please_wait_for_a_while")):(t=t.replace("~PROXY",B.value),t=t.replace("~VERSION",p.value),a(t)):await c("latestElectronVersion not given, Please retry later."):await c("Update link not given. Server might be undergoing maintenance...")}},N=w(!1),ce=()=>{N.value=!0};return(a,t)=>{const d=he,k=_e,P=ge,f=me,E=pe,L=ve,Y=fe,de=xe;return x(),F(de,{show:V.value,"onUpdate:show":t[3]||(t[3]=u=>V.value=u),icon:n(ze),title:n(e)("common.appfunc.check_updates"),height:"auto",onOnLoad:_,"show-setting":"",onOnSettingButtonClicked:ce},{default:l(()=>[s("div",je,[i(E,{class:"card proxy","card-key":"modal-cu-proxy","card-size":"small","disable-glass":"","show-card-border":""},{header:l(()=>[s("div",Fe,[i(d,null,{default:l(()=>[i(n(Ee))]),_:1}),s("span",He,r(n(e)("update.proxy.title")),1),s("div",De,[s("a",{href:"javascript:void(0)",onClick:te},"["+r(n(e)("update.text.proxy_status_view"))+"]",1)])])]),default:l(()=>[s("div",Ge,[t[4]||(t[4]=s("div",{class:"tip-text"},null,-1)),t[5]||(t[5]=s("div",{class:"proxy-actions"},null,-1)),s("div",We,[(x(),b(Ie,null,Re(D,u=>s("div",{class:"proxy-item",key:"proxy-"+u.value},[s("div",Xe,[i(k,{name:"proxy-option",checked:!n(v)&&n(O)===u.value,value:u.value,onChange:se},{default:l(()=>[y(r(u.label),1)]),_:2},1032,["checked","value"])]),s("div",{class:"proxy-ping",style:K(X(u.value))},r(W(u.value)),5)])),64)),s("div",$e,[s("div",Le,[i(k,{name:"proxy-option",checked:n(v),"onUpdate:checked":t[0]||(t[0]=u=>H(v)?v.value=u:null)},{default:l(()=>[y(r(n(e)("update.text.custom_proxy")),1)]),_:1},8,["checked"])]),s("div",Ye,[Ve(i(P,{size:"tiny",value:n(m),"onUpdate:value":t[1]||(t[1]=u=>H(m)?m.value=u:null),style:{width:"250px"}},{suffix:l(()=>[s("div",{class:"proxy-ping",style:K(X(n(m)))}," ("+r(W(n(m)))+") ",5)]),_:1},8,["value"]),[[qe,n(v)]])])])]),s("div",Qe,[i(f,{size:"tiny",onClick:le},{icon:l(()=>[i(d,null,{default:l(()=>[i(n(Ne))]),_:1})]),default:l(()=>[y(" "+r(n(e)("update.text.check_connections")),1)]),_:1})])])]),_:1}),i(L,{class:"card web-version",size:"small",embedded:""},{header:l(()=>[s("div",Ke,[i(d,null,{default:l(()=>[i(n(Oe))]),_:1}),s("span",Ze,r(n(e)("common.hqhelper_version")),1)])]),default:l(()=>[s("div",Je,[s("div",et,[s("div",null,r(n(e)("common.curr_version_with_val",n(j).Version)),1),s("div",null,[s("span",null,r(n(e)("common.latest_version")),1),n(g)?(x(),b("span",tt,r(n(g)),1)):n(g)===""?(x(),b("span",nt,r(n(e)("common.checking")),1)):(x(),b("span",at,r(n(e)("common.check_failed")),1))])]),s("div",ot,[i(f,{size:"tiny",class:"btn-recheck",loading:n(S),onClick:z},{icon:l(()=>[i(d,null,{default:l(()=>[i(n(Z))]),_:1})]),default:l(()=>[y(" "+r(n(e)("common.recheck")),1)]),_:1},8,["loading"])]),s("div",st,[i(f,{class:"btn-do-update",loading:n(o).updating_hqhelper,disabled:!n(J)||n(o).updating_hqhelper,onClick:re},{default:l(()=>[y(r(n(ae)),1)]),_:1},8,["loading","disabled"])])])]),_:1}),i(L,{class:"card web-version",size:"small",embedded:""},{header:l(()=>[s("div",lt,[i(d,null,{default:l(()=>[i(n(Be))]),_:1}),s("span",rt,r(n(e)("common.client_version")),1)])]),default:l(()=>[s("div",it,[s("div",ct,[s("div",null,r(n(e)("common.curr_version_with_val",n(q))),1),s("div",null,[s("span",null,r(n(e)("common.latest_version")),1),n(p)?(x(),b("span",dt,r(n(p)),1)):n(p)===""?(x(),b("span",ut,r(n(e)("common.checking")),1)):(x(),b("span",pt,r(n(e)("common.check_failed")),1))])]),s("div",_t,[i(f,{size:"tiny",class:"btn-recheck",loading:n(S),onClick:z},{icon:l(()=>[i(d,null,{default:l(()=>[i(n(Z))]),_:1})]),default:l(()=>[y(" "+r(n(e)("common.recheck")),1)]),_:1},8,["loading"])]),s("div",gt,[i(f,{class:"btn-do-update",loading:n(o).updating_electron,disabled:!n(ee)||n(o).updating_electron,onClick:ie},{default:l(()=>[y(r(n(oe)),1)]),_:1},8,["loading","disabled"])])])]),_:1}),n(o).error?(x(),F(Y,{key:0,class:"card upd-tip",type:"error",title:n(o).titleText},{default:l(()=>[y(r(n(o).contentText),1)]),_:1},8,["title"])):n(o).updating&&n(o).titleText?(x(),F(Y,{key:1,class:"card upd-tip",type:"info"},{default:l(()=>[y(r(n(o).titleText),1)]),_:1})):Ae("",!0)]),i(we,{show:n(N),"onUpdate:show":t[2]||(t[2]=u=>H(N)?N.value=u:null),"setting-group":"update","app-show-fp":""},null,8,["show"])]),_:1},8,["show","icon","title"])}}}),wt=be(mt,[["__scopeId","data-v-cf8ff126"]]);export{wt as default};
