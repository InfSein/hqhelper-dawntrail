import{f as ue,h as _e,c8 as de,b6 as fe,a as pe,aD as ke,a1 as ve,au as he,at as ge,aB as me,A as ye,b3 as y,n as A,p as $,bZ as P,aV as Q,c7 as we,z as be,e as Ce}from"./index.DjNjFiam.js";import{a_ as Be,a$ as We,b0 as Se,b1 as Oe,b as Ne}from"./icons.BN6_TYLH.js";import{d as xe,k as W,X as Je,r as j,e as D,P as X,o as C,R as p,U as k,Q as c,a as v,c as S,F as Y,Y as Z,n as T,V as w}from"./vendor.DaGD8wRy.js";var e=(i=>(i[i.ConfigBackupUserConfig=5]="ConfigBackupUserConfig",i[i.ConfigBackupFuncConfig=6]="ConfigBackupFuncConfig",i[i.WorkstateBackupMain=9]="WorkstateBackupMain",i[i.WorkstateBackupFtHelper=10]="WorkstateBackupFtHelper",i[i.WorkstateBackupGatherClock=11]="WorkstateBackupGatherClock",i[i.WorkstateBackupWorkflow=12]="WorkstateBackupWorkflow",i[i.WorkstateBackupMacromanage=13]="WorkstateBackupMacromanage",i[i.WorkstateBackupFashioncloth=14]="WorkstateBackupFashioncloth",i[i.WorkstateBackupCsHelper=15]="WorkstateBackupCsHelper",i[i.DataBackupInventory=16]="DataBackupInventory",i))(e||{});const Fe={class:"wrapper"},Me={class:"card-title"},Ue={class:"title"},je={class:"card-title-actions font-small"},De={class:"sync-range-wrapper"},Ie={class:"sync-range-container"},Te={class:"desc"},Ge={key:0,class:"text"},ze={key:1,class:"text error"},Ee={key:2,class:"text"},Re={class:"card-title"},Ve={class:"title"},Ae={class:"start-sync-wrapper"},$e={class:"sync-button-container"},Pe={class:"sync-button-container"},Qe=xe({__name:"ModalCloudSync",props:{show:{type:Boolean,required:!0},showModifiers:{}},emits:["update:show"],setup(i){const a=W("t"),x=W("isMobile"),m=W("userConfig"),B=W("funcConfig"),O=W("cloudConfig"),K=W("appForceUpdate")??(()=>{}),J=ue(),{alertInfo:L,alertError:F,confirm:G}=ye(a),z=_e(),{getListBatch:H,addList:q,editList:ee,resolveListTitle:ae}=de(O),E=Je(i,"show"),d=j(),b=j(Object.values(e).filter(o=>typeof o=="number").reduce((o,_)=>(o[_]=!0,o),{})),M=j(!1),h=j(!1),te=()=>{R()},R=async()=>{M.value=!0;const o={},_=Object.values(e).filter(t=>typeof t=="number"),r=await H(_),s=!r.errno;for(const t of _){let l=0,g="",n=0,u="";if(s&&r.data[t]){const N=r.data[t],{uploadVersion:re,uploadTime:ie}=ae(N.desc);l=ie,g=re,n=N.id,u=N.content}o[t]={load_succeed:s,last_update:l,upload_version:g,id:n,content:u}}if(d.value=o,O.value.nbb_sync_targets==="all")for(const t of _)b.value[t]=!0;else for(const t of _)b.value[t]=O.value.nbb_sync_targets.includes(t);M.value=!1},V=D(()=>[{key:"preferences",title:a("common.appfunc.user_preference"),children:[{value:e.ConfigBackupUserConfig,label:a("common.appsetting.basic_setting")},{value:e.ConfigBackupFuncConfig,label:a("common.appfunc.func_setting")},{value:e.DataBackupInventory,label:a("common.appfunc.ingame_inventory")}]},{key:"workstates",title:a("common.work_state"),children:[{value:e.WorkstateBackupMain,label:a("common.main_ui")},{value:e.WorkstateBackupGatherClock,label:a("common.appfunc.gather_clock")},{value:e.WorkstateBackupFtHelper,label:a("common.appfunc.fthelper")},{value:e.WorkstateBackupCsHelper,label:a("common.appfunc.cshelper")},{value:e.WorkstateBackupFashioncloth,label:a("common.appfunc.fchelper")},{value:e.WorkstateBackupWorkflow,label:a("common.appfunc.workflow")},{value:e.WorkstateBackupMacromanage,label:a("macro_manage.title")}]}]),I=D(()=>{const o={};return V.value.forEach(_=>{_.children.forEach(r=>{o[r.value]=r.label})}),o}),f=D(()=>Object.values(e).filter(o=>typeof o=="number").filter(o=>b.value[o])),U=D(()=>f.value.filter(o=>!d.value?.[o]?.load_succeed).map(o=>I.value[o])),oe=o=>o?a("cloud.text.last_upload",new Date(o).toLocaleString()):a("cloud.text.not_uploaded"),ne=()=>{for(const o of Object.values(e))typeof o=="number"&&(b.value[o]=!0)},se=()=>{for(const o of Object.values(e))typeof o=="number"&&(b.value[o]=!b.value[o])},ce=async()=>{if(h.value=!0,U.value.length){await F(a("cloud.message.cannot_sync_because_modules_data_load_failed")+`
-> `+U.value.join(", ")+`
`+a("cloud.message.please_refresh_and_retry")),h.value=!1;return}if(!await G(a("cloud.message.confirm_upload_1")+`
`+a("cloud.message.confirm_upload_2"))){h.value=!1;return}const o=[];for(const s of f.value){const t=await r(s);t.errno&&o.push(a("cloud.message.sync_error",{mod:I.value[s],err:t.errmsg}))}o.length?await F(a("cloud.message.following_modules_sync_failed")+`
`+o.join(`
`)):z.success(a("cloud.message.sync_succeed"));const _=y(O.value);_.nbb_sync_targets=f.value,J.setCloudConfig(_),K(),await R(),h.value=!1;async function r(s){let t="";switch(s){case e.ConfigBackupUserConfig:{const n=y(m.value);delete n.cache_work_state,delete n.fthelper_cache_work_state,delete n.gatherclock_cache_work_state,delete n.workflow_cache_work_state,delete n.macromanage_cache_work_state,delete n.fashioncloth_cache_work_state,t=JSON.stringify(n);break}case e.ConfigBackupFuncConfig:{const n=y(B.value);delete n.inventory_statement_enable_sync,delete n.inventory_workflow_enable_sync,delete n.inventory_other_items_way,delete n.inventory_data,delete n.cache_item_prices,t=JSON.stringify(n);break}case e.WorkstateBackupMain:t=JSON.stringify(m.value.cache_work_state);break;case e.WorkstateBackupFtHelper:t=JSON.stringify(m.value.fthelper_cache_work_state);break;case e.WorkstateBackupGatherClock:t=JSON.stringify(m.value.gatherclock_cache_work_state);break;case e.WorkstateBackupWorkflow:{const n=Q(m.value.workflow_cache_work_state);t=JSON.stringify(n);break}case e.WorkstateBackupMacromanage:{const n=P(m.value.macromanage_cache_work_state);t=JSON.stringify(n);break}case e.WorkstateBackupFashioncloth:{const n=$(m.value.fashioncloth_cache_work_state);t=JSON.stringify(n);break}case e.WorkstateBackupCsHelper:{const n=A(m.value.cshelper_cache_work_state);t=JSON.stringify(n);break}case e.DataBackupInventory:t=JSON.stringify({inventory_statement_enable_sync:B.value.inventory_statement_enable_sync,inventory_workflow_enable_sync:B.value.inventory_workflow_enable_sync,inventory_other_items_way:B.value.inventory_other_items_way,inventory_data:B.value.inventory_data});break;default:return{errno:1,errmsg:"Unexpected listtype"+s,data:{}}}const l=!d.value[s].id;let g;if(l)g=await q(s,t);else{const n=d.value[s].id;g=await ee(n,t)}return g}},le=async()=>{if(h.value=!0,U.value.length){await F(a("cloud.message.cannot_sync_because_modules_data_load_failed")+`
-> `+U.value.join(", ")+`
`+a("cloud.message.please_refresh_and_retry")),h.value=!1;return}const o=f.value.filter(u=>!d.value?.[u]?.last_update).map(u=>I.value[u]);if(o.length){await F(a("cloud.message.cannot_sync_because_modules_data_not_uploaded")+`
-> `+o.join(", ")+`
`+a("cloud.message.please_upload_first")),h.value=!1;return}if(!await G(a("cloud.message.confirm_download_1")+`
`+a("cloud.message.confirm_download_2"))){h.value=!1;return}let _=!1;const r=y(m.value);let s=y(m.value);f.value.includes(e.ConfigBackupUserConfig)&&(s=JSON.parse(d.value[e.ConfigBackupUserConfig].content)),s.cache_lasttime_version=r.cache_lasttime_version,f.value.includes(e.WorkstateBackupMain)?s.cache_work_state=JSON.parse(d.value[e.WorkstateBackupMain].content):s.cache_work_state=r.cache_work_state,f.value.includes(e.WorkstateBackupFtHelper)?s.fthelper_cache_work_state=JSON.parse(d.value[e.WorkstateBackupFtHelper].content):s.fthelper_cache_work_state=r.fthelper_cache_work_state,f.value.includes(e.WorkstateBackupGatherClock)?s.gatherclock_cache_work_state=JSON.parse(d.value[e.WorkstateBackupGatherClock].content):s.gatherclock_cache_work_state=r.gatherclock_cache_work_state,f.value.includes(e.WorkstateBackupWorkflow)?s.workflow_cache_work_state=Q(JSON.parse(d.value[e.WorkstateBackupWorkflow].content)):s.workflow_cache_work_state=r.workflow_cache_work_state,f.value.includes(e.WorkstateBackupMacromanage)?s.macromanage_cache_work_state=P(JSON.parse(d.value[e.WorkstateBackupMacromanage].content)):s.macromanage_cache_work_state=r.macromanage_cache_work_state,f.value.includes(e.WorkstateBackupFashioncloth)?s.fashioncloth_cache_work_state=$(JSON.parse(d.value[e.WorkstateBackupFashioncloth].content)):s.fashioncloth_cache_work_state=r.fashioncloth_cache_work_state,f.value.includes(e.WorkstateBackupCsHelper)?s.cshelper_cache_work_state=A(JSON.parse(d.value[e.WorkstateBackupCsHelper].content)):s.cshelper_cache_work_state=r.cshelper_cache_work_state,JSON.stringify(r)!==JSON.stringify(s)?(console.log(`userconfig json diff.
`,JSON.stringify(r),JSON.stringify(s)),_=!0,s=we(s),J.setUserConfig(s)):console.log("[CloudSync] Tip: no changes for userConfig.");const t=y(B.value);let l=y(B.value);if(f.value.includes(e.ConfigBackupFuncConfig)&&(l=JSON.parse(d.value[e.ConfigBackupFuncConfig].content)),f.value.includes(e.DataBackupInventory)){const u=JSON.parse(d.value[e.DataBackupInventory].content);l.inventory_statement_enable_sync=u.inventory_statement_enable_sync,l.inventory_workflow_enable_sync=u.inventory_workflow_enable_sync,l.inventory_other_items_way=u.inventory_other_items_way,l.inventory_data=y(u.inventory_data)}else l.inventory_statement_enable_sync=t.inventory_statement_enable_sync,l.inventory_workflow_enable_sync=t.inventory_workflow_enable_sync,l.inventory_other_items_way=t.inventory_other_items_way,l.inventory_data=y(t.inventory_data);let g=!1;t.universalis_server!==l.universalis_server?(l.cache_item_prices={},g=!0):l.cache_item_prices=t.cache_item_prices,JSON.stringify(t)!==JSON.stringify(l)?(console.log(`funcconfig json diff.
`,JSON.stringify(t),JSON.stringify(l)),_=!0,l=be(l),J.setFuncConfig(l)):console.log("[CloudSync] Tip: no changes for funcConfig.");const n=y(O.value);if(n.nbb_sync_targets=f.value,J.setCloudConfig(n),h.value=!1,_){const u=[a("cloud.message.sync_succeed")];g&&u.push(a("cloud.message.cache_cleaned")),u.push(a("cloud.message.page_would_be_reloaded")),await L(u.join(`
`)),setTimeout(()=>{window.electronAPI?.closeAllChildWindows?.(),location.reload()},500)}else z.success(a("cloud.message.data_consistent"))};return(o,_)=>{const r=he,s=ve,t=pe,l=ge,g=fe;return C(),X(me,{show:E.value,"onUpdate:show":_[0]||(_[0]=n=>E.value=n),icon:c(Ne),title:c(a)("cloud.text.data_sync"),"max-width":"600px",onOnLoad:te},{default:p(()=>[k(g,{show:c(M)},{default:p(()=>[v("div",Fe,[k(t,{size:"small",embedded:""},{header:p(()=>[v("div",Me,[k(r,null,{default:p(()=>[k(c(Be))]),_:1}),v("span",Ue,w(c(a)("cloud.text.sync_range")),1),v("div",je,[v("a",{href:"javascript:void(0)",onClick:ne},"["+w(c(a)("common.select_all"))+"]",1),v("a",{href:"javascript:void(0)",onClick:se},"["+w(c(a)("common.select_invert"))+"]",1)])])]),default:p(()=>[v("div",De,[(C(!0),S(Y,null,Z(c(V),n=>(C(),X(ke,{key:n.key,title:n.title},{default:p(()=>[v("div",Ie,[(C(!0),S(Y,null,Z(n.children,u=>(C(),S("div",{key:`syncrange-${u.value}`,class:"item"},[k(s,{checked:c(b)[u.value],"onUpdate:checked":N=>c(b)[u.value]=N},{default:p(()=>[T(w(u.label),1)]),_:2},1032,["checked","onUpdate:checked"]),v("div",Te,[c(M)?(C(),S("div",Ge,w(c(a)("cloud.text.loading")),1)):c(d)?.[u.value]?.load_succeed?(C(),S("div",Ee,w(oe(c(d)[u.value].last_update)),1)):(C(),S("div",ze,w(c(a)("common.load_failed")),1))])]))),128))])]),_:2},1032,["title"]))),128))])]),_:1}),k(t,{size:"small",embedded:""},{header:p(()=>[v("div",Re,[k(r,null,{default:p(()=>[k(c(Oe))]),_:1}),v("span",Ve,w(c(a)("cloud.text.start_sync")),1)])]),default:p(()=>[v("div",Ae,[k(l,{text:!c(x),loading:c(h),disabled:c(h)||!c(f).length,onClick:ce},{default:p(()=>[v("div",$e,[k(r,{size:c(x)?16:48},{default:p(()=>[k(c(We))]),_:1},8,["size"]),T(" "+w(c(a)("cloud.text.upload_data")),1)])]),_:1},8,["text","loading","disabled"]),k(l,{text:!c(x),loading:c(h),disabled:c(h)||!c(f).length,onClick:le},{default:p(()=>[v("div",Pe,[k(r,{size:c(x)?16:48},{default:p(()=>[k(c(Se))]),_:1},8,["size"]),T(" "+w(c(a)("cloud.text.download_data")),1)])]),_:1},8,["text","loading","disabled"])])]),_:1})])]),_:1},8,["show"])]),_:1},8,["show","icon","title"])}}}),Ke=Ce(Qe,[["__scopeId","data-v-59ed3c99"]]);export{Ke as default};
